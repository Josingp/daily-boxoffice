name: Daily Scrape

on:
  schedule:
    - cron: '0 * * * *' # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ì‹¤ì‹œê°„ ì˜ˆë§¤ìœ¨ìš©)
  workflow_dispatch:    # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Pip ìºì‹± (ì†ë„ í–¥ìƒ)
    - name: Cache Pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4

    # 1. ì‹¤ì‹œê°„ ì˜ˆë§¤ìœ¨ (ë§¤ ì‹œê°„ ë¬´ì¡°ê±´ ì‹¤í–‰)
    - name: Run Realtime Ranking
      continue-on-error: true
      env:
        KOBIS_API_KEY: ${{ secrets.KOBIS_API_KEY }}
      run: python scripts/update_realtime.py

    # 2. ì¼ë³„ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ (í•œêµ­ì‹œê°„ ì•„ì¹¨ 7ì‹œ = UTC 22ì‹œì—ë§Œ ì‹¤í–‰)
    - name: Run Daily Box Office
      continue-on-error: true
      env:
        KOBIS_API_KEY: ${{ secrets.KOBIS_API_KEY }}
      run: |
        # í˜„ì¬ UTC ì‹œê°„(ì‹œ) êµ¬í•˜ê¸°
        HOUR=$(date -u +%H)
        
        # UTC 22ì‹œ(í•œêµ­ 07ì‹œ) ì´ê±°ë‚˜, ìˆ˜ë™ ì‹¤í–‰(workflow_dispatch)ì¼ ë•Œë§Œ ì‘ë™
        if [ "$HOUR" == "22" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "â° It's 07:00 KST. Running Daily Box Office Update..."
          python scripts/update_daily.py
        else
          echo "ğŸ’¤ Skipping Daily Box Office (Current UTC: $HOUR, Target: 22)"
        fi

    # 3. ë“œë¼ë§ˆ ì‹œì²­ë¥  (í•œêµ­ì‹œê°„ ì•„ì¹¨ 7ì‹œ = UTC 22ì‹œì—ë§Œ ì‹¤í–‰)
    - name: Run Drama Scraper
      continue-on-error: true
      run: |
        HOUR=$(date -u +%H)
        
        if [ "$HOUR" == "22" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "â° It's 07:00 KST. Running Drama Scraper..."
          python scripts/update_drama.py
        else
          echo "ğŸ’¤ Skipping Drama Scraper (Current UTC: $HOUR, Target: 22)"
        fi

    - name: Commit and Push
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add public/
        
        # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ì—†ì´ ì¢…ë£Œ
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        git commit -m "Update data: $(date +'%Y-%m-%d %H:%M')"
        
        # ìµœì‹  ì½”ë“œ ë‹¹ê²¨ì™€ì„œ ì¶©ëŒ ë°©ì§€
        git pull --rebase origin main
        
        git push
